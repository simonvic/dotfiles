#!/bin/bash

###########################################
#	Made by
#       _                              _
#      (_)                            (_)
#  ___  _  ____    ___   ____   _   _  _   ____
# /___)| ||    \  / _ \ |  _ \ | | | || | / ___)
#|___ || || | | || |_| || | | | \ V / | |( (___
#(___/ |_||_|_|_| \___/ |_| |_|  \_/  |_| \____)

#	Check updates and give a look at my dotfiles here:
#		https://github.com/simonvic/dotfiles

###########################################

poweredOnLabel=""
poweredOffLabel= #""
connectedLabel=""

##
#	Get if bluetooth is powered on
#	@return true|false
function isPowered() {
	[[ ! -z $(bluetoothctl show | grep "Powered: yes") ]] && echo true || echo false
}

##
#	Get if connected to a bluetooth device
#	@return true|false
function isConnected() {
	[[ ! -z $(bluetoothctl info | grep "Connected: yes") ]] && echo true || echo false
}

##
#	Print status label for polybar
#	@return label
function printStatus() {
	if $(isPowered); then
		if $(isConnected); then
			echo "$connectedLabel"
		else
			echo "$poweredOnLabel"
		fi
	else
		echo "$poweredOffLabel"
	fi

}

##
#	Change bluetooth power
#	@param toggle,on or off
function power() {
	if [ $1 == "toggle" ]; then
		if $(isPowered); then
			bluetoothctl power off
		else
			bluetoothctl power on
		fi
	else
		bluetoothctl power $1
	fi
	updatePolybar
}


##
#	Find the device UUID given a name
#	@param device name
#	@return device UUID
function findDeviceUUID() {
	bluetoothctl devices | grep -i $1 | awk -F ' ' '{print $2}'
}


##
#	Connect to a device
#	@param device name
function connect() {
	if [ ! -z $1 ]; then
		if ! $(isPowered); then
			power on
		fi
		bluetoothctl connect $(findDeviceUUID $1)
		updatePolybar
	else
		printUsage
	fi
}

##
#	Update all polybar modules of bluetooth
function updatePolybar() {
	sPolybarctl message "action bluetooth hook 0"
	# sPolybarctl message "action earbuds hook 0"
	# sPolybarctl message "action earbuds-extended hook 0"
}

function printUsage() {
	printf "
- Usage
	sBluetoothctl <options>
	
- Options
	help                                # Show this help
	print                               # Print the current status label
	power <toggle|on|off>               # Switch on or off the bluetooth, or toggle between the states
	connect <device UUID|device Name>   # Power on bluetooth if necessary and connect to <device UUID> (xx:xx:xx:xx:xx:xx) or <device Name> (i.e. 'Galaxy buds')

- Abbreviations
	p = power
	c = connect
"
}

case $1 in
print) printStatus ;;
power | p) power $2 ;;
connect | c) connect $2 ;;
help | *) printUsage ;;
esac
