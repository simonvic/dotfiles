#!/bin/bash
###########################################
#	Made by
#       _                              _
#      (_)                            (_)
#  ___  _  ____    ___   ____   _   _  _   ____
# /___)| ||    \  / _ \ |  _ \ | | | || | / ___)
#|___ || || | | || |_| || | | | \ V / | |( (___
#(___/ |_||_|_|_| \___/ |_| |_|  \_/  |_| \____)

#	Check updates and give a look at my dotfiles here:
#		https://github.com/simonvic/dotfiles

###########################################

# Max limit of the volume
maxVolume=100

#	Default icon
mutedIcon=/usr/share/icons/Vimix-Ruby/22/panel/audio-volume-muted.svg
lowIcon=/usr/share/icons/Vimix-Ruby/22/panel/audio-volume-low.svg
icon=/usr/share/icons/Vimix-Ruby/22/panel/audio-volume-medium.svg
warningIcon=/usr/share/icons/Vimix-Ruby/22/panel/audio-volume-high.svg

# Enable to play sound
playSound=true
# Sound to play (usually located in /usr/share/sounds/)
sound=/usr/share/sounds/freedesktop/stereo/audio-volume-change.oga

# Default urgency level [Available: low, normal, critical]
urgency=normal

# At which level the volume is considered too high
warningLevel=60

# For how much milliseconds the notification will stay visible
timeout=1500

# Unique dunst notification id
uid=6909

# App name in dunst
appName="simonvic.Volume"

function getVolume() {
	pactl get-sink-volume @DEFAULT_SINK@ | head -n1 | cut -d '/' -f 2 | sed 's|%||'
}

function isMute() {
	[[ $(pactl get-sink-mute @DEFAULT_SINK@) == "Mute: yes" ]] && echo true || echo false
}

function setMute() {
	pactl set-sink-mute @DEFAULT_SINK@ "$1"
}

function increaseVolume() {
	setMute false
	local increaseAmount=$1
	local currentVolume=$(getVolume)
	[[ $((currentVolume + increaseAmount)) -gt $maxVolume ]] \
		&& setVolume "$maxVolume%" \
		|| setVolume "+$increaseAmount%"
}

function decreaseVolume() {
	setMute false
	setVolume "-$1%"
}

function setVolume() {
	pactl set-sink-volume @DEFAULT_SINK@ "$1"
}

function buildBar() {
	$HOME/.config/i3/scripts/drawBar.sh $1 $2 $3
}

function sendNotification() {
	local volume=$(getVolume)

	# Building the volume bar
	body="$(buildBar 5 $volume false)\t<b>$volume%</b>\t"

	if [ $volume -ge $warningLevel ]; then
		urgency=critical
		icon=$warningIcon
	elif [ $volume -le 20 ]; then
		icon=$lowIcon
	fi

	if [ $playSound = true ]; then
		paplay $sound &
	fi

	# Send the notification
	dunstify -a "$appName" -i "$icon" -t "$timeout" -r "$uid" -u "$urgency" "$volume" "$body"
}

function printUsage() {
	printf "
- Usage
	sVolumectl <options>
	
- Options
	help                     # Show this help
	increase [amount]        # Increase speaker/headphone volume by [amount] if specified or the default value otherwise
	decrease [amount]        # Decrease speaker/headphone volume by [amount] if specified or the default value otherwise
	mute [true|false|toggle] # Set mute status for the speakers/headphones
	
- Abbreviations
	i = increase
	d = decrease
	m = mute
"
}

case $1 in
increase | i)
	# Set the volume on (if it was muted)
	increaseVolume "$2"
	sendNotification
	;;
decrease | d)
	decreaseVolume "$2"
	sendNotification
	;;
mute | m)
	setMute "$2"
	if $(isMute); then
		# Building the volume bar
		body="$(buildBar 5 100 true)\t<b>Muted</b>\t"
		dunstify -a $appName -i $mutedIcon -t "$timeout" -r "$uid" -u "$urgency" "Muted" "$body"
	else
		sendNotification
	fi
	;;
help | *) printUsage ;;
esac
